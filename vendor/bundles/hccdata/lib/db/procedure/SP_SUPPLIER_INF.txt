CREATE OR REPLACE PROCEDURE HVCCT_MES.SP_INF_MASTER
 IS
 V_CHECK_CNT		NUMBER(10);
 V_CURRENT_DOMAIN	VARCHAR2(64);
BEGIN
  -- CURRENT DOMAIN
  SELECT ID INTO V_CURRENT_DOMAIN FROM DOMAINS WHERE SYSTEM_FLAG = 1 ORDER BY CREATED_AT ASC;

  -- 1. CUSTOMERS
	BEGIN
    -- Customer interface 테이블에서 valdate가 현재 시간보다 이전이고 DOWNLOAD_YN = 'N'인 데이터를 찾는다.
		FOR CUR_ORD IN (
  			SELECT 
				IC.CODE AS NAME, IC.DESCRIPTION AS DESCRIPTION
			FROM 
				INF_CUSTOMER IC 
			WHERE 
				IC.DOWNLOAD_YN  = 'N' AND IC.VALDATE < SYSDATE
		)

	LOOP
    -- 있으면 SKIP, 없으면 INSERT
    BEGIN
      SELECT COUNT(*) INTO V_CHECK_CNT FROM CUSTOMERS WHERE NAME = CUR_ORD.NAME;
      IF(V_CHECK_CNT = 0) THEN
        INSERT INTO CUSTOMERS(ID, DOMAIN_ID, NAME, DESCRIPTION, CREATED_AT, UPDATED_AT)
        VALUES (
          CONCAT(CONCAT(V_CURRENT_DOMAIN, '-'), CUR_ORD.NAME)
          , V_CURRENT_DOMAIN
          , CUR_ORD.NAME
          , CUR_ORD.DESCRIPTION
          , SYSDATE
          , SYSDATE
        );
        UPDATE INF_CUSTOMER SET DOWNLOAD_YN  = 'Y', DOWNLOAD_TIME = SYSDATE WHERE CODE = CUR_ORD.NAME AND DESCRIPTION = CUR_ORD.DESCRIPTION;
      ELSE
        UPDATE INF_CUSTOMER SET DOWNLOAD_YN  = 'S', DOWNLOAD_TIME = SYSDATE WHERE CODE = CUR_ORD.NAME AND DESCRIPTION = CUR_ORD.DESCRIPTION;
      END IF;

      EXCEPTION
        WHEN OTHERS THEN
        	DBMS_OUTPUT.PUT_LINE('# ERROR1 : ' || TO_CHAR(SQLCODE));
      END;
  END LOOP;

  COMMIT;

  EXCEPTION
    WHEN OTHERS THEN
    	DBMS_OUTPUT.PUT_LINE('# ERROR2 : ' || TO_CHAR(SQLCODE));
    ROLLBACK;
  END;
END SP_INF_MASTER;