create or replace
PROCEDURE           SP_PROD_PLAN_INF
 IS

 D_CURDATE 										DATE;
 V_CURDATE										VARCHAR2(64);
 D_TODATE 										DATE;
 V_TODATE										  VARCHAR2(64);
 NEW_PLAN_CNT									NUMBER;
BEGIN

  D_CURDATE := SYSDATE + 1;
  V_CURDATE := TO_CHAR(D_CURDATE, 'DD/MM/YYYY');
  D_TODATE := SYSDATE + 8;
  V_TODATE := TO_CHAR(D_TODATE, 'DD/MM/YYYY');

  SELECT COUNT(*) INTO NEW_PLAN_CNT FROM INF_PROD_PLAN WHERE (WORK_DATE BETWEEN V_CURDATE AND V_TODATE) AND DOWNLOAD_YN = 'N';

  IF ( NEW_PLAN_CNT > 0) THEN
  	DELETE FROM PROD_PLANS WHERE PLAN_DATE BETWEEN TO_DATE(V_CURDATE, 'DD/MM/YYYY') AND TO_DATE(V_TODATE, 'DD/MM/YYYY');

		INSERT INTO
			PROD_PLANS (
				ID
      	, DOMAIN_ID
      	, PLAN_DATE
      	, WORKCENTER_ID
      	, OPERATION_ID
      	, PRODUCT_ID
      	, CUSTOMER_ID
      	, SHIFT1_PLAN_QTY
      	, SHIFT1_SEQ
      	, SHIFT2_PLAN_QTY
      	, SHIFT2_SEQ
      	, TOTAL_PLAN_QTY
      	, CREATED_AT
      	, UPDATED_AT)
			SELECT
    		TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')||dbms_random.string('U', 10) AS ID,
      	OPERATIONS.DOMAIN_ID AS DOMAIN_ID,
				TO_DATE(to_char(to_date(IPP.WORK_DATE, 'dd/mm/yyyy'), 'yyyy-mm-dd'), 'yyyy-mm-dd') AS PLAN_DATE,
				OPERATIONS.WORKCENTER_ID AS WORKCENTER_ID,
				OPERATIONS.ID AS OPERATION_ID,
				PRODUCTS.ID AS PRODUCT_ID,
				CUSTOMERS.ID AS CUSTOMER_ID,
				IPP.SHIFT1_QTY AS SHIFT1_PLAN_QTY,
				IPP.SHIFT1_SEQ AS SHIFT1_SEQ,
				IPP.SHIFT2_QTY AS SHIFT2_PLAN_QTY,
				IPP.SHIFT2_SEQ AS SHIFT2_SEQ,
				IPP.SHIFT1_QTY + IPP.SHIFT2_QTY AS TOTAL_PLAN_QTY,
      	SYSDATE AS CREATED_AT,
      	SYSDATE AS UPDATED_AT
			FROM INF_PROD_PLAN IPP
				INNER JOIN OPERATIONS ON OPERATIONS.name = IPP.ROUTING_CODE
				INNER JOIN PRODUCTS ON PRODUCTS.NAME = IPP.PRODUCT_CODE
				LEFT OUTER JOIN CUSTOMERS ON CUSTOMERS.NAME = IPP.OPT_CODE
    	WHERE
    		(IPP.WORK_DATE BETWEEN V_CURDATE AND V_TODATE) AND
      	((IPP.SHIFT1_QTY IS NOT NULL AND IPP.SHIFT1_QTY > 0) OR (IPP.SHIFT2_QTY IS NOT NULL AND IPP.SHIFT2_QTY > 0)) AND
      	IPP.DOWNLOAD_YN != 'Y';

  	UPDATE
			INF_PROD_PLAN IPP
  	SET
  		IPP.DOWNLOAD_YN  = 'Y', IPP.DOWNLOAD_TIME = SYSDATE
  	WHERE
  		IPP.WORK_DATE BETWEEN V_CURDATE AND V_TODATE;

  	COMMIT;

   END IF;

EXCEPTION
	WHEN OTHERS THEN
  ROLLBACK;
END;